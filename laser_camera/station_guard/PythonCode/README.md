Station Guard System - Complete Refactoring Architecture Guide
变电站监护系统 - 完整重构架构指南

版本：1.0

日期：2025年12月

作者：Ronan

Executive Summary (执行摘要)
本指南提供了一份完整的重构路线图，旨在将您现有的单人测距系统转型为一个与硬件无关的、支持多人（1-10人）和多机柜（1-N）的入侵检测内核，既适用于生产环境部署，也适合学术发表。

核心架构原则是关注点分离（Separation of Concerns）：传感器硬件的差异被隔离在适配器中，而所有的业务逻辑则在标准化的 2D 地面坐标系上运行。这使您能够更换传感器、添加新硬件并持续演进系统，而无需重写核心检测逻辑。

Key Architectural Benefits (核心架构优势)

工程方面：

能够利用现有硬件立即部署。

硬件无关的核心层支持未来传感器升级，无需重新设计系统。

配置驱动的区域和权限管理，能够快速适应不同现场。

全面的审计日志支持运维合规检查和故障调试。

科研方面：

清晰的数学公式（点-多边形几何），适合论文发表。

模块化设计允许对融合算法进行独立测试。

基于日志的回放功能支持可复现的实验。

可扩展至博弈论建模和多智能体场景。

💡 Part 0 核心总结 本项目将从“原型”转变为“平台”。通过硬件解耦，既满足工程落地的灵活性（换硬件不改代码），又满足学术研究的严谨性（纯几何数学模型）。

Part 1: System Architecture Overview (系统架构概览)
1.1 Core Architectural Layers (核心架构层级)
系统采用严格的五层管道架构：

第 1 层：传感器适配层（硬件相关）

相机适配器：检测 + 跟踪 → 跟踪ID + 边界框

测距适配器：LiDAR/深度 → 距离测量

灯光适配器：GPIO/串口 → 灯光控制

(输出：标准化数据格式)

第 2 层：地面投影层

相机脚点 (u,v) → 横向位置 y

测距距离 d → 纵向位置 x

输出：走廊地面上的以米为单位的人员坐标 P(x,y)

第 3 层：多目标跟踪与融合

跨帧保持跟踪 ID

融合视觉（横向）+ 测距（纵向）数据

检测冲突，过滤离群值

处理遮挡和跟踪丢失

第 4 层：区域逻辑与状态机（核心内核）

区域的点-多边形测试

到边界的距离计算

每人 5 级状态分类（正常、压线、越线、错位、高危）

权限表查询

第 5 层：输出与控制

审计日志（CSV/JSON）：帧级 + 事件触发

三色灯：绿/黄/红（遵循最坏情况优先原则）

UI 显示：区域、人员标记、状态文本

1.2 Data Flow Principles (数据流原则)
翻译： 上行流（传感器 → 决策）：

每层接收严格类型的、与硬件无关的数据结构。

下层绝不包含业务逻辑或区域定义。

适配器故障需被优雅处理，不导致系统崩溃。

下行流（决策 → 执行）：

状态机输出触发离散事件（日志条目、灯光变化）。

控制信号是确定性的，可根据状态复现。

执行器没有反馈回路回到决策逻辑。

💡 Part 1 核心总结 建立了严格的单向数据管道。数据从硬件适配层向上流动，逐步转化为纯几何坐标，由核心层决策后，再向下输出控制信号。这种分层确保了模块间的低耦合。

Part 2: Core Kernel Modules (核心内核模块)
2.1 Geometry Engine (几何引擎)
翻译： 本模块为所有区域检测提供数学基础。必须对其进行彻底测试，因为它构成了安全决策的“基本真理”。

设计说明：

所有坐标均为地面平面上的米制坐标（世界坐标）。

多边形顶点必须有序（顺时针或逆时针）。

边界情况（点正好在边界上）需一致处理。

不依赖任何传感器硬件或配置。

测试优先级： 在编写任何其他模块之前先编写单元测试，因为这些函数是安全关键的。

2.2 Zone Configuration (区域配置)
翻译： 本模块从配置文件定义所有空间区域，消除硬编码的几何形状。

(数据结构描述摘要：定义了授权区、缓冲区、危险区、机柜扇区的类结构) (配置文件结构摘要：使用YAML定义坐标系原点、授权区多边形、缓冲区线段、危险区和机柜扇区)

2.3 Ground Plane Projector (地面投影器)
翻译： 本模块将传感器坐标转换为地面平面上的世界坐标。

视觉到地面（横向位置）： 您现有的视觉系统提供脚点像素坐标。投影器将这些映射为横向位置 y。

测距到地面（纵向位置）： 您现有的 LiDAR 系统提供距离测量。投影器将这些映射为纵向位置 x。

融合投影器： 结合两种投影以创建完整的 2D 地面位置。

2.4 Multi-Target Tracking (多目标跟踪)
翻译： 本模块在多帧之间保持多人的持久身份，处理遮挡和跟踪丢失。

关键算法：

位置平滑： 使用移动平均或卡尔曼滤波平滑噪声位置估计。

速度估计： 从位置历史计算速度以进行运动预测。

离群值检测： 剔除违反物理约束的突变位置。

跟踪恢复： 尝试在丢失的轨迹重新出现时重新识别它们。

2.5 Sensor Fusion Logic (传感器融合逻辑)
翻译： 本模块结合视觉和测距测量，解决冲突并提高准确性。

冲突解决： 当视觉和测距显著不一致时：

横向位置 (y) 信任视觉 - 相机是该轴的主传感器。

纵向位置 (x) 信任测距 - LiDAR/深度是距离的主传感器。

如果测距不可用或不可靠，根据视觉 BBox 大小估计距离。

如果冲突持续存在，将轨迹标记为低置信度并应用保守过滤。

2.6 State Machine & Status Classification (状态机与状态分类)
翻译： 这是核心决策引擎，根据每个人的位置和区域配置对其状态进行分类。

(状态枚举：NORMAL, ON_LINE, CROSS_LINE, MISPLACED, HIGH_RISK)

全局警报聚合： 应用最坏情况优先规则：

红灯：如果任何人处于 CROSS_LINE / MISPLACED / HIGH_RISK。

黄灯：如果任何人处于 ON_LINE（且无红灯条件）。

绿灯：如果所有人都是 NORMAL。

2.7 Audit Logging (审计日志)
翻译： 本模块为调试、合规和研究分析提供全面的日志记录。

日志类型：

帧日志： 记录每一帧的系统状态。

事件日志： 记录离散事件（越线、警报变化）。

💡 Part 2 核心总结 这是系统的“大脑”。所有物理世界的信息被转化为数学模型（点与多边形）。核心亮点是双重融合策略（视觉定横向，雷达定纵向）和5级安全状态机（严格定义了从正常到高危的判断逻辑）。

Part 3: Sensor Adapter Layer (传感器适配层)
3.1 Adapter Interface Design (适配器接口设计)
翻译： 所有适配器遵循通用的接口模式，以确保硬件的可交换性。

(描述了相机适配器、测距适配器、灯光适配器的抽象基类结构)

3.2 Wrapping Your Existing Code (封装现有代码)
翻译： 相机适配器 (YOLO Wrapper)： 封装您现有的 YOLO 人员检测代码。 测距适配器 (LiDAR ToF Wrapper)： 封装您现有的 TOF LiDAR 代码。

3.3 Adapter Integration Pattern (适配器集成模式)
翻译： 您的主应用程序应该使用适配器，而无需了解硬件细节。

💡 Part 3 核心总结 这是系统的“手脚”。通过 Adapter 模式，将您现有的旧代码（LiDAR驱动、YOLO识别）打包成标准插件。主程序只调用标准接口，完全不关心底层是哪种雷达或相机。

Part 4: Migration Strategy (迁移策略)
4.1 Three-Phase Rollout (三阶段实施)
翻译：

阶段 A：几何核心（2-3 天）

目标： 构建并测试与硬件无关的数学基础。

成功标准： 所有几何测试 100% 通过；不依赖真实传感器。

阶段 B：适配器集成（3-4 天）

目标： 封装现有硬件代码，将真实数据输入几何核心。

成功标准： 能检测单人并正确分类状态；LiDAR 和视觉数据正确融合。

阶段 C：多人与全系统（4-5 天）

目标： 扩展至多人，添加完整日志，集成 UI。

成功标准： 系统处理 5+ 人无混乱；所有事件被记录；能回放日志；UI 显示正确。

4.2 File-by-File Changes (逐文件变更)
翻译：

极小变更： 您现有的 lidar_tof.py 和视觉核心代码保持不变。

新封装文件： 创建新的 lidar_tof_adapter.py 和 camera_yolo.py。

替换数据源： 修改 UI 代码，从新的 station_guard 输出读取数据，而非直接访问传感器。

4.3 Configuration Migration (配置迁移)
翻译： 需要从旧代码（如 cabinet_positioning.py）中提取硬编码的机柜坐标、相机分辨率、走廊尺寸等，转换为新的 YAML 配置文件。

💡 Part 4 核心总结 实施路线非常稳健：先写数学库（不碰硬件），再写适配器（接硬件），最后做系统集成。这样最大程度降低了重构风险，且保证了旧代码的复用。

Part 5: Testing & Validation Strategy (测试与验证策略)
5.1 Unit Testing Priority (单元测试优先级)
翻译：

最高优先级（安全关键）： 几何函数（点在多边形内、距离计算）和状态机逻辑。

中等优先级： 传感器融合和跟踪管理。

较低优先级： 端到端集成场景。

5.2 Real-World Testing Scenarios (实地测试场景)
翻译：

场景 1：单人权限检查。（进入授权区绿灯，进入非授权区红灯+错位）

场景 2：黄线穿越。（接近黄线亮黄灯，越过亮红灯）

场景 3：多人跟踪。（两人分别行动，系统独立维护状态，全局警报取最坏情况）

5.3 Performance Benchmarks (性能基准)
翻译：

部署目标指标：延迟 < 100ms/帧，误报率 < 1%，漏检率 < 2%。

分析工具：使用 cProfile 识别热点，使用内存分析器检测泄漏。

💡 Part 5 核心总结 强调了“测试驱动开发”的思想，特别是对核心几何算法的测试，因为它是安全判定的基石。

Part 6: Documentation & Handoff (文档与移交)
6.1 Operator Manual (操作手册)
翻译： 创建包括安装指南、配置指南（如何编辑 YAML）、操作手册和故障排除指南在内的文档。

6.2 Developer Documentation (开发者文档)
翻译： 为未来维护和研究提供：架构概览、API 参考、算法文档（数学证明）和扩展指南。

6.3 Research Paper Outline (论文大纲)
翻译： 为学术发表准备的大纲：

标题建议：《基于几何区域分析与传感器融合的硬件无关多人入侵检测》

章节涵盖：系统架构、几何建模、传感器融合、多人跟踪、评估与结论。

💡 Part 6 核心总结 这一部分不仅是为了交付代码，更是为了交付“资产”。操作手册保证了工程交付，论文大纲保证了学术价值。

Part 7: Immediate Next Steps (立即执行的下一步)
Your Action Plan (您的行动计划)
翻译： 第 1 周：核心几何基础

第 1-2 天：创建并测试 core/geometry2d.py（实现射线法、距离计算）。

第 3-4 天：创建 core/zones.py 和配置系统。

第 5 天：创建状态机逻辑。

第 2 周：适配器集成

第 6-7 天：创建适配器基类并封装 LiDAR。

第 8-9 天：封装视觉代码。

第 10 天：实现坐标投影和基本融合。

第 3 周：多人与集成

第 11-12 天：实现跟踪和多人融合。

第 13-14 天：添加日志和回放。

第 15 天：UI 集成与部署。

Conclusion (结语)
翻译： 本次重构通过以下方式将您的单人原型转变为生产级、可发表研究的系统：

硬件解耦 - 传感器变为可插拔的适配器。

几何形式化 - 所有决策追溯到数学的点-多边形测试。

支持多人跟踪 - 从 1 人扩展到 10+ 人。

提供全审计能力 - 每个决策都被记录且可复现。

简化配置 - 新现场仅需编辑 YAML，无需更改代码。

架构设计旨在最小化对现有代码的干扰。您保留所有现有的硬件驱动和检测算法——它们只是被包裹在适配器中。新的核心模块在不破坏现有功能的情况下增加了能力。


# Station Guard System - 变电站走廊多人越界检测内核

硬件解耦的安全监控系统，支持多人实时跟踪与五状态分类。

## 系统特点

- **硬件无关**：传感器通过适配器接入，核心逻辑独立于具体硬件
- **几何驱动**：所有决策基于严格的点-多边形几何计算
- **配置驱动**：区域定义和授权规则完全在YAML配置文件中定义
- **多人跟踪**：支持同时跟踪1-10人并独立分类状态
- **完整审计**：帧级和事件级日志记录所有决策过程

## 五状态分类

1. **NORMAL** - 正常：在授权区域内，无违规
2. **ON_LINE** - 压线：进入警戒线缓冲区
3. **CROSS_LINE** - 越线：跨越警戒线进入禁区
4. **MISPLACED** - 错位：在未授权的机柜区域
5. **HIGH_RISK** - 高危：进入或接近危险区域

## 快速开始

### 安装依赖
```bash
pip install -r requirements.txt
```

### 运行测试
```bash
pytest tests/ -v
```

### 运行最小演示
```bash
python apps/minimal_demo.py
```

## 目录结构

- `core/` - 核心算法（硬件无关）
- `adapters/` - 硬件适配器
- `apps/` - 应用程序
- `config/` - 配置文件
- `tests/` - 测试套件
- `tools/` - 辅助工具
- `logs/` - 运行日志

## 文档

详细文档请参考：
- 架构说明：查看交付的 REFACTORING_GUIDE.md
- 实施计划：查看交付的 IMPLEMENTATION_PLAN.md

## 版本

当前版本：0.1.0（开发中）